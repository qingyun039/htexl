% 中平肿瘤筛查报告
\documentclass{ctexbook}
\usepackage{geometry}
\usepackage{fancyhdr}
\usepackage{graphics}
\usepackage{xcolor}
\usepackage{etoolbox}
\usepackage{pdfpages}
\usepackage[absolute,overlay]{textpos}
\usepackage{tikz}
\usetikzlibrary{calc}
%\usepackage{background}

\geometry{paperwidth=8.27in,paperheight=11.22in, margin=25mm, includehead, includefoot}
\fancyhf{}
\fancyhead[OL]{\includegraphics[scale=1]{<!= $item->{'性别'} eq '女' ? 'zptmrfemalehdr.eps' : 'zptmrmalehdr.eps' !>}}
\fancyhead[ER]{\includegraphics[scale=1]{header1.eps}}
\fancyfoot[OL,RE]{\color{black!60}\sffamily 【\quad\thepage\quad{}】}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
\pagestyle{fancy}

\setCJKsansfont{Source Han Sans CN Medium}[BoldFont=Source Han Sans CN Bold]
\setsansfont{Source Han Sans CN Medium}[BoldFont=Source Han Sans CN Bold]

\setlength{\TPHorizModule}{1mm}
\setlength{\TPVertModule}{1mm}

\newcommand{\myrule}[1]{
	\makebox[0pt][l]{\raisebox{-6pt}{\rule{6em}{1.2pt}}}\makebox[6em]{#1}%
}
\newcommand{\infopage}{
	\begin{textblock}{178}(17.5, 180)
		\LARGE\sffamily\centering\noindent
			姓\qquad{}名:\myrule{\hyname}\quad{}性\qquad{}别:\myrule{\hysex} \\[1.2em]
			\ 年\qquad{}龄:\myrule{\hyage}\quad{}样本编号:\myrule{\hycode}
	\end{textblock}
}

% eps图片
\newcounter{gene}
\newcounter{rsid}
\newcounter{geno}
\newcommand{\addGene}[1]{%
	\stepcounter{gene}%
	\csdef{gene\thegene}{#1}%
}
\newcommand{\addRsid}[1]{%
	\stepcounter{rsid}%
	\csdef{rsid\thersid}{#1}%
}
\newcommand{\addGeno}[1]{%
	\stepcounter{geno}%
	\csdef{geno\thegeno}{#1}
}
\newcommand{\A}[1]{%
	\raisebox{-36pt}{\textcolor{gray}{%
		~\parbox{200pt}{%
			\sffamily%
			检测位点： \csuse{rsid#1}\\%
			检测基因： \csuse{gene#1}\\%
			基因分型： \csuse{geno#1}
		}
	}}%
}


\definecolor{high}{RGB}{252,65,78}
\definecolor{low}{RGB}{130,203,81}
\definecolor{avg}{RGB}{244,195,68}
\newcommand{\tmrbar}[1]{
	\def\list{#1}
	\begin{tikzpicture}[scale=.8,font=\bfseries\sffamily\color{black!60}, minimum height=20pt]
	\draw[line width=1.5pt,black!60, line cap=rect] (0,0) -- (13,0);
	\foreach[count=\i] \x in {0.2,0.4,0.6,0.8,1.0,1.2,1.4,1.6,$\infty$}{
		\node[below] at (\i*1.44,0) {\x};
	}
	\node[below] (0,0) {0};
	\foreach[count=\i] \c/\r  in \list{
		\gdef\maxitem{\i}
		\coordinate (a\i) at (0, .8*\i);
	}
	\gdef\barclr{avg}
	\foreach[count=\i] \c/\r  in \list{
		\let\s=\r
		\ifthenelse{\lengthtest{\r pt<0.8pt}}{\gdef\barclr{low}}{
		\ifthenelse{\lengthtest{\r pt>1.2pt}}{\gdef\barclr{high}}{\gdef\barclr{avg}}}
		\ifthenelse{\lengthtest{\r pt>1.71pt}}{\def\r{1.71}}{}
		\node[anchor=east] at (a\i) {\c};
		\draw[line width=4pt,\barclr] (a\i){[line cap=round] -- ++(7.2*\r, 0)} node[anchor=west] {\s};
	}
	\draw[line width=1.5pt, black!60] (0,0) -- (a\maxitem) -- ++(0, .7);
	\end{tikzpicture}
}
\newcommand{\tmrpoint}[1]{
	\def\list{#1}
	\begin{tikzpicture}[font=\bfseries\sffamily\color{black!60}, minimum height=20pt]
	\foreach[count=\i] \x in {0.2,0.4,0.6,0.8,1.0,1.2,1.4,1.6,$\infty$}{
		\draw[black!60,thick, dash pattern=on 2pt off 6pt] (0,\i*0.8)  node[anchor=east] {\x} -- (\textwidth,\i*0.8);
	}
	\draw[black!60, line width=1.5pt] (0,0)  node[anchor=east] {0} -- (\textwidth,0);
	\foreach[count=\i] \c/\r  in \list{\gdef\maxitem{\i}}
	\dimendef\jian=0
	\pgfmathsetlength{\jian}{\textwidth/(\maxitem+1)}
	\foreach[count=\i] \c/\r  in \list{
		\let\s=\r
		\ifthenelse{\lengthtest{\r pt<0.8pt}}{\gdef\barclr{low}}{
			\ifthenelse{\lengthtest{\r pt>1.2pt}}{\gdef\barclr{high}}{\gdef\barclr{avg}}}
		\ifthenelse{\lengthtest{\r pt>1.71pt}}{\def\r{1.71}}{}
		\node[below] at (\jian*\i, 0) {\c};
		\node[above,\barclr] at (\jian*\i, \r*4) {\r};
		\fill[\barclr] (\jian*\i, \r*4) circle (3pt);
		\draw[\barclr] (\jian*\i, \r*4) circle (4pt);
		
	}
	\end{tikzpicture}
}

!= include 'layouts/userinfo';
\input{tools}
\begin{document}
\pagecolor[RGB]{243,244,244}
! my $tpl = 'zptmrmale';
! $tpl = 'zptmrfemale' if $item->{'性别'} eq '女';
<!
my $paper_height = 285;
my $trims_above = 60; 
my $trims_below = 150;
!>
\includepdf[pages=1, pagecommand={\thispagestyle{empty}\infopage}]{<!= $tpl !>}
\includepdf[pages={2-4}]{<!= $tpl !>}
\setcounter{page}{1}
\includepdf[pages=5,pagecommand={}]{<!= $tpl !>}
\vspace*{20mm}
\includepdfpart{6}{60mm}{210mm}{<!= $tpl !>}

\vspace{5mm}\centering
\definecolor{myclr}{RGB}{33,50,124}
\tmrbar{<!= join ',', map { $_->{tumor}.'/'.$_->{risk} } @$result !>}

\includepdfpart{6}{213mm}{47mm}{<!= $tpl !>}
\newpage
! my $page = 7; my $i = 0;
! foreach my $tumor (@$result){
\setcounter{gene}{0}\setcounter{rsid}{0}\setcounter{geno}{0}
!     foreach my $rs (@{$tumor->{rss}}){
\addGene{<!= $rs->{gene} !>}\addRsid{<!= $rs->{rsid} !>}\addGeno{<!= $rs->{genotype} !>}
!     }
\vspace*{20mm}
\includepdfpart{<!= $page++ !>}{<!= $trims_above !>mm}{<!= $paper_height - $trims_below !>mm}{<!= $tpl !>}
\vspace*{1cm}
\begin{center}
	\input{zptmrfour.eps_tex}

	\vspace*{3mm}
	{\sffamily\bfseries\large\color{black!70} 检测结果： <!= $tumor->{level} !> }
\end{center}
\includepdf[pages=<!= $page++ !>,pagecommand={}]{<!= $tpl !>}
\includepdf[pages=<!= $page++ !>,pagecommand={}]{<!= $tpl !>}
! }
\includepdf[pages={<!= $page++ !>-},pagecommand={}]{<!= $tpl !>}

\end{document}